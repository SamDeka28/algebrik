name: Algebrik-website-cicd
on:
  push:
    branches:
      - prod



jobs:
  sonar-scan:
    runs-on: ubuntu-latest
    permissions: read-all
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - uses: Algebrik-AI/github-actions/sonar-scan-2.0@prod
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN_PROD_BRANCH }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  code-scanner:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    if: github.event_name == 'push'
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Use Code Scanner Workflow
      uses: Algebrik-AI/github-actions/code-scanner@prod
  build_and_deploy:
    permissions:
      id-token: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v2
        with:
          node-version: '20.18'

      - name: Build
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
        run: |
          npm install
          npm run build
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::779846782923:role/github_action_role
          aws-region: us-east-1

      - name: Deploy latest build
        run: |
          BRANCH=${GITHUB_REF##*/}
          TARGET=`jq -r ".[\"$BRANCH\"]" .github/workflows/mapping.json`
          echo $TARGET
          aws s3 sync ./out/ s3://$TARGET/
          
          echo ::set-output name=target::$TARGET
        id: deploy

      - name: Invalidate CDN cache www.algebrik.com
        run: |
          TARGET=${{ steps.deploy.outputs.target }}
          echo TARGET:$TARGET
          # DISTRIBUTION_ID=$(aws cloudfront list-distributions --output json | jq -r '.DistributionList.Items[] | select(.Aliases and .Aliases.Items and (.Aliases.Items | any(. == "'$TARGET'"))) | .Id')
          DISTRIBUTION_ID=E3T710U4WVTQ47
          echo DISTRIBUTION_ID:$DISTRIBUTION_ID
          INVALIDATION_ID=`aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*" --output json | jq -r .Invalidation.Id`
          echo INVALIDATION_ID:$INVALIDATION_ID
          aws cloudfront wait invalidation-completed --distribution-id $DISTRIBUTION_ID --id $INVALIDATION_ID
      - name: Invalidate CDN cache www.algebrik.ai
        run: |
          TARGET='www.algebrik.ai'
          echo TARGET:$TARGET
          # DISTRIBUTION_ID=$(aws cloudfront list-distributions --output json | jq -r '.DistributionList.Items[] | select(.Aliases and .Aliases.Items and (.Aliases.Items | any(. == "'$TARGET'"))) | .Id')
          DISTRIBUTION_ID=E1UG2HN8EB2BC6
          echo DISTRIBUTION_ID:$DISTRIBUTION_ID
          INVALIDATION_ID=`aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*" --output json | jq -r .Invalidation.Id`
          echo INVALIDATION_ID:$INVALIDATION_ID
          aws cloudfront wait invalidation-completed --distribution-id $DISTRIBUTION_ID --id $INVALIDATION_ID
